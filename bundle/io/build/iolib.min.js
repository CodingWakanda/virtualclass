/*
  2014 Pinky Sharma  {@link http://vidyamantra.com}
 @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
*/
var $jscomp=$jscomp||{};$jscomp.scope={};$jscomp.checkStringArgs=function(a,b,c){if(null==a)throw new TypeError("The 'this' value for String.prototype."+c+" must not be null or undefined");if(b instanceof RegExp)throw new TypeError("First argument to String.prototype."+c+" must not be a regular expression");return a+""};$jscomp.ASSUME_ES5=!1;$jscomp.ASSUME_NO_NATIVE_MAP=!1;$jscomp.ASSUME_NO_NATIVE_SET=!1;
$jscomp.defineProperty=$jscomp.ASSUME_ES5||"function"==typeof Object.defineProperties?Object.defineProperty:function(a,b,c){a!=Array.prototype&&a!=Object.prototype&&(a[b]=c.value)};$jscomp.getGlobal=function(a){return"undefined"!=typeof window&&window===a?a:"undefined"!=typeof global&&null!=global?global:a};$jscomp.global=$jscomp.getGlobal(this);
$jscomp.polyfill=function(a,b,c,d){if(b){c=$jscomp.global;a=a.split(".");for(d=0;d<a.length-1;d++){var e=a[d];e in c||(c[e]={});c=c[e]}a=a[a.length-1];d=c[a];b=b(d);b!=d&&null!=b&&$jscomp.defineProperty(c,a,{configurable:!0,writable:!0,value:b})}};
$jscomp.polyfill("String.prototype.startsWith",function(a){return a?a:function(a,c){var b=$jscomp.checkStringArgs(this,a,"startsWith");a+="";var e=b.length,f=a.length;c=Math.max(0,Math.min(c|0,b.length));for(var g=0;g<f&&c<e;)if(b[c++]!=a[g++])return!1;return g>=f}},"es6","es3");
var io={cfg:{},sock:null,wsuri:null,error:null,uniquesids:null,serial:null,globallock:!1,readyToSend:!1,globalmsgjson:[],packetQueue:[],binMsgQueue:[],jsnMsgQueue:[],recBinMsgQueue:[],recjsnMsgQueue:null,init:function(a,b){this.cfg=a;this.wsconnect()},wsconnect:function(){console.log("init for socket connect");io.wsuri=this.cfg.rid;"WebSocket"in window?this.sock=new WebSocket(io.wsuri):"MozWebSocket"in window?this.sock=new MozWebSocket(io.wsuri):(console.log("Browser does not support WebSocket!"),
this.error=lang.wserror);var a=this;this.sock.onopen=function(){this.readyToSend=!1;console.log("Connected to "+a.cfg.rid);$.event.trigger({type:"connectionopen"});a.userauthenticate();a.addclient()};this.sock.binaryType="arraybuffer";this.sock.onmessage=function(a){if(a.data instanceof ArrayBuffer)io.onRecBinary(a);else if(a=io.cleanRecJson(a.data)){var b=JSON.parse(a);this.recjsnMsgQueue="";b.hasOwnProperty("m")?b.m.hasOwnProperty("serial")?ioMissingPackets.checkMissing(b):b.m.hasOwnProperty("reqMissPac")?
virtualclass.recorder.hasOwnProperty("startUpload")||ioMissingPackets.sendMissedPackets(b):b.m.hasOwnProperty("missedpackets")?(console.log("Execute missed packets"),ioMissingPackets.fillExecutedStore(b)):b.m.hasOwnProperty("userSerial")?ioMissingPackets.userCheckMissing(b):b.m.hasOwnProperty("userReqMissPac")?virtualclass.recorder.hasOwnProperty("startUpload")||ioMissingPackets.userSendMissedPackets(b):b.m.hasOwnProperty("userMissedpackets")?ioMissingPackets.userFillExecutedStore(b):(io.onRecSave(b,
a),io.onRecJson(b)):(io.onRecSave(b,a),io.onRecJson(b))}};this.sock.onerror=function(b){a.error=b;console.log("Error:"+b);$.event.trigger({type:"error",message:b})};this.sock.onclose=function(b){console.log("Connection Closed");$.event.trigger({type:"connectionclose",message:b.reason});console.log("Connection closed (wasClean = "+b.wasClean+", code = "+b.code+", reason = '"+b.reason+"')");setTimeout(function(){virtualclass.gObj.hasOwnProperty("saveSession")||virtualclass.gObj.hasOwnProperty("downloadProgress")||
virtualclass.recorder.uploadInProcess||virtualclass.gObj.hasOwnProperty("invalidlogin")&&virtualclass.gObj.invalidlogin||a.wsconnect()},5E3)}},userauthenticate:function(){var a="F-AH-"+JSON.stringify({authuser:this.cfg.authuser,authpass:this.cfg.authpass});this.sock.send(a)},addclient:function(){var a="F-JR-"+JSON.stringify({client:this.cfg.userid,roomname:this.cfg.room,user:this.cfg.userobj});this.sock.send(a)},send:function(a,b,c){a.hasOwnProperty("m")&&"all"==a.m.user&&alert("som packet are sending");
a={cfun:b,arg:{msg:a}};c&&(a.arg.touser=c);if(this.webSocketConnected()){if(0<io.packetQueue.length){for(c=0;c<io.packetQueue.length;c++)b=JSON.parse(io.packetQueue[c]),this.realSend(b);io.packetQueue.length=0}this.realSend(a)}else console.log("SOCKET is not ready."),c=JSON.stringify(a),io.packetQueue.push(c)},realSend:function(a){if("undefined"!=typeof a.arg.touser)if(null==io.uniquesids)console.log("uniqueid is null");else if(a.arg.touser=io.uniquesids[a.arg.touser],"undefined"==typeof a.arg.touser){console.log("User is not connected."+
a.arg.touser);return}var b={name:wbUser.name,lname:wbUser.lname,role:wbUser.role,userid:wbUser.id};switch(a.cfun){case "broadcastToAll":if("undefined"==typeof a.arg.touser)b={type:"broadcastToAll",user:b,m:a.arg.msg},a='F-BR-{"0'+JSON.stringify(b);else{b={type:"broadcastToAll",user:b,m:a.arg.msg,userto:a.arg.touser};for(a=a.arg.touser;12>a.length;)a="0"+a;a='F-BRU-{"'+a+'{"0'+JSON.stringify(b)}break;case "ping":b={type:"PONG",m:a.arg.msg};a="F-PI-"+JSON.stringify(b);break;case "speed":a='F-SPE-{"'+
a.arg.msg;break;default:a=JSON.stringify(a)}if(6E5>=a.length)this.sock.send(a),this.sock.onerror=function(a){};else{if(this.jsnMsgQueue=this.chunkSubstr(a,55E4))for(a=0;a<this.jsnMsgQueue.length;a++)this.sock.send(this.jsnMsgQueue[a]);this.jsnMsgQueue=[]}},chunkSubstr:function(a,b){if(a.startsWith('F-BR-{"0')){var c='F-BR-{"';a=a.replace('F-BR-{"0',"")}else if(a.startsWith('F-BRU-{"'))c=a.substring(0,22),a=a.substring(23,a.length);else return!1;for(var d=Math.ceil(a.length/b),e=Array(d),f=0,g=0;f<
d;++f,g+=b)e[f]=a.substr(g,b),e[f]=0==f?c+"1"+e[f]:f<d-1?c+"2"+e[f]:c+"3"+e[f];return e},cleanRecJson:function(a){if(!(a.startsWith('{"0{"')||a.startsWith('{"1{"')||a.startsWith('{"2')||a.startsWith('{"3')))return a;if(a.startsWith('{"0{"'))return a=a.replace('{"0{"','{"');if(a.startsWith('{"1{"'))this.recjsnMsgQueue=a.replace('{"1{"','{"');else if(a.startsWith('{"2'))0<this.recjsnMsgQueue.length&&(this.recjsnMsgQueue+=a.replace('{"2',""));else if(a.startsWith('{"3')){if(0<this.recjsnMsgQueue.length)return this.recjsnMsgQueue+=
a.replace('{"3',"")}else this.recjsnMsgQueue="";return!1},sendBinary:function(a){if(this.webSocketConnected()&&a.length)if(6E5>=a.length){if(a.constructor===Int8Array)var b=new Int8Array(a.length+2);else a.constructor===Uint8ClampedArray&&(b=new Uint8ClampedArray(a.length+2));b.set([a[0],0]);b.set(a,2);this.sock.send(b.buffer);ioStorage.dataBinaryStore(b)}else{this.binMsgQueue=[];for(var c=b=0;b<a.length;c++){var d=a.slice(b,b+55E4);a.constructor===Int8Array?this.binMsgQueue[c]=new Int8Array(d.length+
2):a.constructor===Uint8ClampedArray&&(this.binMsgQueue[c]=new Uint8ClampedArray(d.length+2));this.binMsgQueue[c].set([a[0],2]);this.binMsgQueue[c].set(d,2);d.length&&(b+=d.length)}this.binMsgQueue[0][1]=1;this.binMsgQueue[this.binMsgQueue.length-1][1]=3;for(a=0;a<this.binMsgQueue.length;a++)this.sock.send(this.binMsgQueue[a].buffer),ioStorage.dataBinaryStore(this.binMsgQueue[a]);this.binMsgQueue=[]}},onRecMessage:function(a){if(a.data instanceof ArrayBuffer)this.onRecBinary(a);else{var b=JSON.parse(a.data);
this.onRecSave(b,a.data);io.onRecJson(b,a.data)}},onRecSave:function(a,b){(!a.hasOwnProperty("userto")||a.hasOwnProperty("userto")&&a.m.hasOwnProperty("eddata"))&&ioStorage.completeStorage(b)},onRecBinary:function(a){if(a.data instanceof ArrayBuffer){var b=new Uint8Array(a.data);if(0==b[1])b=b.subarray(2),b=101==b[0]?new Int8Array(b):new Uint8ClampedArray(b),ioStorage.dataBinaryStore(b),$.event.trigger({type:"binrec",message:b.buffer});else if(1==b[1])this.recBinMsgQueue=[],this.recBinMsgQueue[0]=
b.subarray(2);else if(2==b[1])0<this.recBinMsgQueue.length&&this.recBinMsgQueue.push(b.subarray(2));else if(3==b[1]&&0<this.recBinMsgQueue.length){this.recBinMsgQueue.push(b.subarray(2));var c=0;for(a=0;a<this.recBinMsgQueue.length;a++)c+=this.recBinMsgQueue[a].length;b=101==b[0]?new Int8Array(c):new Uint8ClampedArray(c);for(c=a=0;a<this.recBinMsgQueue.length;a++)b.set(this.recBinMsgQueue[a],c),c+=this.recBinMsgQueue[a].length;ioStorage.dataBinaryStore(b);$.event.trigger({type:"binrec",message:b.buffer})}}},
webSocketConnected:function(){return io.sock&&1==io.sock.readyState&&1==this.readyToSend},onRecJson:function(a){if(!1===io.globallock)if(0<io.globalmsgjson.length)for(;0<io.globalmsgjson.length&&!1===io.globallock;)a=io.globalmsgjson.shift(),io.onRecJsonIndividual(a);else if(null!=a&&!1===io.globallock&&0==io.globalmsgjson.length)io.onRecJsonIndividual(a);else null!=a&&io.globalmsgjson.push(a);else null!=a&&io.globalmsgjson.push(a)},onRecJsonIndividual:function(a){var b="";switch(a.type){case "joinroom":console.log("New user join room "+
a.users);this.readyToSend=!0;var c=null;null!=io.uniquesids&&$.each(a.clientids,function(a,b){void 0==io.uniquesids[a]&&(c=a)});io.uniquesids=a.clientids;b={type:"member_added",newuser:c,joinUser:a.action};a.hasOwnProperty("users")?(b.message=a.users,b.users=!0):a.hasOwnProperty("user")&&(b.message=a.user,b.user=!0);$.event.trigger(b);break;case "broadcastToAll":case "broadcast":null!==a&&(void 0!=a.userto&&(b=a.userto),$.event.trigger({type:"newmessage",message:a.m,fromUser:a.user,toUser:virtualclass.vutil.getUserAllInfo(b,
virtualclass.connectedUsers)}));break;case "userleft":console.log("Case:- userleft");void 0!=a.userto&&(b=a.userto);null!=io.uniquesids&&delete io.uniquesids[a.user.userid];$.event.trigger({type:"user_logout",fromUser:a.user,message:"offline",toUser:virtualclass.vutil.getUserAllInfo(b,virtualclass.connectedUsers)});break;case "leftroom":console.log("Case:- leftroom");$.event.trigger({type:"member_removed",message:a.user});break;case "Unauthenticated":console.log("Case:- unauthenticated");$.event.trigger({type:"authentication_failed",
message:"Authentication failed"});break;case "Multiple_login":console.log("Case:- Multiple_login");$.event.trigger({type:"Multiple_login"});break;case "PONG":$.event.trigger({type:"PONG",message:a.m});break;case "Text_Limit_Exeed":$.event.trigger({type:"Text_Limit_Exeed"});break;case "Binary_Limit_Exeed":$.event.trigger({type:"Binary_Limit_Exeed"});break;case "Max_rooms":$.event.trigger({type:"Max_rooms"});break;case "Max_users":$.event.trigger({type:"Max_rooms"})}},disconnect:function(){this.sock.onclose=
function(){};this.sock.close();console.log("i am closing this connection")}};
